<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map editor for Epitech runner</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script
        src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
        crossorigin="anonymous"></script>
</head>
<body class="m-2">
    <input type="number" id="size-x">
    <input type="number" id="size-y">
    <button type="button" class="btn btn-primary" id="generate">Generate grid</button>
    <hr>
    <div id="dest_grid">
    </div>
    <hr>
    <input hidden type="file" id="config"></input>
    <label style="cursor: pointer" class="text-primary mb-2" for="config"><u>Importer ma configuration</u></label> <a href="/config_runner.json">(Exemple)</a>
    <div id="toolbox">
    </div>
    <hr>
    <div class="text-center my-3">
        <input hidden type="file" id="import"></input>
        <label class="btn btn-secondary m-0" for="import">Importer une map</label>
        <button type="button" class="btn btn-success" id="export">Exporter la map</button>
    </div>
    <p class="text-center" id="credits"><a href="https://www.linkedin.com/in/mathias-andr%C3%A9-a7b30721a/">Créé par <b>Mathias</b> ❤️</a></p>
</body>
<style>
*:not(pre) {
    user-select: none;
    -webkit-user-drag: none;
}
#dest_grid::-webkit-scrollbar {
  display: none;
}
#dest_grid {
  overflow: scroll;
  max-width: 100%;
  max-height: 70%;
  -ms-overflow-style: none;
  scrollbar-width: none;
  display: inline-grid;
  border: 1px solid black;
  grid-gap: 1px;
  background-color: black;
}

#dest_grid > div {
  background-color: white;
  padding: 15px;
  text-align: center;
}
#toolbox > div {
  cursor: pointer;
  padding: 15px 0;
  width: 53px;
  margin: 5px;
  text-align: center;
  display: inline-block;
}
.btn {
    cursor: pointer;
}
</style>
<script>
    var sprites = {}
    var mode = "horizontal"
    var current_draw = 0;
    var clicking = false;
    var keys = [];
    var width = 0;
    var height = 0;
    var exported_map = "";
    var pen_type = 0;
    $("#import").on("change", function () {
        let fr = new FileReader();
        fr.onload = function () {
            let imported_map = fr.result.split('\n').filter(e => e)
            if (mode == "vertical") {
                generate_grid(imported_map.length, imported_map[0].length)
                for (j = 0; j < width; j++)
                    for (i = height - 1; i >= 0; i--) {
                        let block_id = imported_map[j][i];
                        console.log(block_id)
                        $("#dest_grid > div[column="+j+"][row="+(height - 1 - i)+"]").attr("block_id", block_id).css("background-color", sprites[block_id])
                    }
            } else {
                generate_grid(imported_map[0].length, imported_map.length)
                for (j = 0; j < height; j++)
                    for (i = 0; i < width; i++) {
                        let block_id = imported_map[j][i];
                        $("#dest_grid > div[column="+i+"][row="+j+"]").attr("block_id", block_id).css("background-color", sprites[block_id])
                    }
            }
        }
        fr.readAsText($(this).get(0).files[0])
    })
    $("#config").on("change", function () {
        let fr = new FileReader();
        fr.onload = function () {
            let config = JSON.parse(fr.result);
            sprites = config.sprites;
            width = config.width;
            height = config.height;
            mode = config.mode;
            generate_grid(width, height);
            generate_colors();
        }
        fr.readAsText($(this).get(0).files[0])
    })
    $(document).on("keydown", function (e) {
        let key = e.originalEvent.keyCode
        if (!keys.includes(key))
            keys.push(key)
    })

    $(document).on("keyup", function (e) {
        let key = e.originalEvent.keyCode
        keys = keys.filter(function (el) {
            return (el != key)
        })
    })

    function generate_colors () {
        $("#toolbox").html("")
        for (block in sprites) {
            $("#toolbox").append("<div block_id="+block+" style=\"background-color: "+sprites[block]+"\">"+block+"</div>")
        }
        $("#toolbox > div").click(function() {
            current_draw = parseInt($(this).attr("block_id"));
        })
    }

    $("#export").click(function() {
        exported_map = "";
        if (mode == "vertical")
            for (j = 0; j < width; j++) {
                for (i = height - 1; i >= 0; i--) {
                    let block_id = $("#dest_grid > div[column="+j+"][row="+i+"]").attr("block_id")
                    exported_map += (block_id == undefined ? ' ' : block_id)
                }
                exported_map += '\n'
            }
        else
            for (j = 0; j < height; j++) {
                for (i = 0; i < width; i++) {
                    let block_id = $("#dest_grid > div[column="+i+"][row="+j+"]").attr("block_id")
                    exported_map += (block_id == undefined ? ' ' : block_id)
                }
                exported_map += '\n'
            }
        $("html").html("<pre>"+exported_map+"</pre>")
    })

    function generate_grid(nwidth, nheight)
    {
        $("#dest_grid div").remove();
        width = nwidth;
        height = nheight;
        for (j = 0; j < height; j++)
            for (i = 0; i < width; i++)
                $("#dest_grid").append("<div column="+i+" row="+j+"></div>");
        $("#dest_grid").css("grid-template-columns", "repeat("+width+", 30px)")
        $("#dest_grid > div").mouseover(function() {
            if (clicking)
                if (pen_type == 1) {
                    $(this).css("background-color", sprites[parseInt(current_draw)])
                    $(this).attr("block_id", current_draw)
                } else {
                    $(this).css("background-color", "white")
                    $(this).removeAttr("block_id")
                }
        })
        $("#dest_grid > div").mousedown(function() {
            if ($(this).attr("block_id") != current_draw) {
                pen_type = 1
                if (keys.includes(16)) {
                    $("#dest_grid > div[row="+$(this).attr("row")+"]").css("background-color", sprites[parseInt(current_draw)])
                    $("#dest_grid > div[row="+$(this).attr("row")+"]").attr("block_id", current_draw)
                }
                $(this).css("background-color", sprites[parseInt(current_draw)])
                $(this).attr("block_id", current_draw)
            } else {
                pen_type = 1
                if (keys.includes(16)) {
                    $("#dest_grid > div[row="+$(this).attr("row")+"]").css("background-color", "white")
                    $("#dest_grid > div[row="+$(this).attr("row")+"]").removeAttr("block_id")
                }
                $(this).css("background-color", "white")
                $(this).removeAttr("block_id")
            }
        })
    }
    $(document).mousedown(function () {
            clicking = true;
        })
    $(document).mouseup(function () {
            clicking = false;
        })
    $("#generate").click(function() {
        generate_grid(parseInt($("#size-x").val()), parseInt($("#size-y").val()))
    })
    if ($("#credits b").text()[0] != 'M' || $("#credits b").text()[6] != 's') {
            alert("On laisse les crédits <3")
            $("html").html("")
    }
</script>
</html>
